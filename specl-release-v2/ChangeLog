2013-03-06  Gary V. Vaughan  <gary@gnu.org>

	maint: distribute README.md.
	* Makefile.am (EXTRA_DIST): Add README.md.

	rockspecs: build from github zip file.
	Rather than require git clone to checkout the source tree at
	rockspec install time, download the automatic github zip file.
	* specl-rockspec.lua (source): Extrapolate zip file location.
	(source.branch): Remove.
	* src/specl.mk (specl_install_edit): Use pkgluadir and libdir
	to match luarocks installation dirs.
	* yaml/yaml.mk (luaexec_LTLIBRARIES): Rename from this...
	(lib_LTLIBRARIES): ...to this, or luarocks doubles up the
	installation subdirectories to lua/5.x/lua/5.x!

	rockspecs: fix missing quote in build_command.
	* specl-rockspec.lua (build.build_command): Add missing quote.

	maint: don't distribute compiled Lua specs.
	* specs/specs.mk (SPECLC): Path to speclc program.
	(specl_SPECS): Remove Lua spec files.
	(specl_LUASPECS): List Lua spec files.
	(.yaml.lua): Make sure there is a specs dir in the build tree.
	(DISTCLEANFILES): Remove generated lua spec files.

	maint: distribute specl-rockspec.lua.
	* Makefile.am (EXTRA_DIST): Add specl-rockspec.lua.

	specl: always pass a (small) number to os.exit().
	os.exit in Lua 5.1 doesn't accept a boolean, so we pass it 1 if
	there are any failures, otherwise 0.
	* src/specl.lua (run): Return a small integer suitable for os.exit.
	* src/specl.in: Remove completed TODO.

	specl: use loadstring for Lua 5.1 compatibility.
	* src/specl.lua (loadstring): If loadstring is not defined, then
	this must be Lua 5.2, so define a loadstring work-a-like around
	load.
	* src/specl.in (slurp): Use loadstring, either from Lua 5.1 core,
	or the wrapper above.

2013-02-28  Gary V. Vaughan  <gary@gnu.org>

	maint: more TODO items.
	* TODO.yaml: New items.

	specl: support continued (undocumented!) specl-1 _spec.lua specs.
	* src/specl.in (slurp): First try to load as pure Lua, and if
	that fails, fall back to the YAML loader before erroring.
	* src/specl.lua (copile_specs, compile_examples, compile_example):
	Factor out compilation phase for YAML specs.
	* build-aux/speclc.in: New file. %_spec.yaml to %_spec.lua
	compiler (requires lyaml!).
	* specs/specs.mk (build-aux/speclc): Build it from speclc.in.
	(.yaml.lua): New rule to compile all yaml specs to lua to make
	sure Lua specs continue to be fully functional.
	(specl_SPECS): Add lua specs.
	* build-aux/.gitignore: Add speclc.
	* specs/environment_spec.yaml: Comment out a spec that fails
	when loaded as a lua spec, but passes as a yaml spec :-?
	* TODO.yaml: Remove done items.

	maint: keep track of TODO items in the repository.
	* TODO.yaml: New file. List pending TODO items.

	yaml: compile lua fragments on the fly instead of requiring `!lua`.
	* yaml/lyaml.c (load_scalar): Remove `!lua` precompiling support.
	* src/specl.lua (compile_example): New function to compile an
	example.
	(run_examples): Use it when encountering an uncompiled example.
	* specs/environment_spec.yaml, specs/matchers_spec.yaml,
	specs/specl_spec.yaml: Remove all `!lua` tags.
	* specs/specl_spec.yaml: New expectations for yaml specs on CLI
	standard input.
	* README.md: Update documentation. Particularly removing the
	notes about dealing with quirks of `!lua`.

	specs: specify exit statuses
	* specs/specl_spec.yaml (describe specl): New examples to specify
	exit status of specl.
	(describe matchers): Move everything else from here...
	* specs/matchers_spec.yaml: ...to here.

	maint: GNUmakefile improvements.
	* GNUmakefile (unpack-distcheck-release): Be sure to rebuild rockspecs.
	(check-in-release): Commit all unpacked files on the release branch.

	rockspecs: allow arbitrary revision numbers.
	* build-aux/mkrockspecs.lua (qualified_version): New value.
	Extract this from the template, in case this is not a revision -1
	rockspec.

2013-02-26  Gary V. Vaughan  <gary@gnu.org>

	specl: return non-zero exit status when there are failing specs.
	* src/specl.lua (run): Return false when there are failing tests.

	maint: call woger properly at release time.
	* GNUmakefile (WOGER_ENV): Lua environment settings for extracting
	woger release variables.
	(WOGER_OUT): Lua call for feretting out the rockspec file
	settings used by woger.
	(release): Fully populate all the fields needed to make a correct
	woger release of Specl.

2013-02-25  Gary V. Vaughan  <gary@gnu.org>

	docs: update README to document new YAML syntax spec files.
	* README.md: Updated to document new YAML syntax spec files.

	configury: user-overridable search for install libyaml.
	* configure.ac (AC_CHECK_HEADERS): Look for yaml.h.
	(AC_SEARCH_LIBS): Abort with an error if libyaml is not found.
	* yaml/yaml.mk (yaml_lyaml_la_LIBADD): Remove hardcoded -lyaml.
	* specl-rockspec.lua (external_dependencies): Add yaml.
	(build.build_command): Pass through YAML options from rockspec
	make command.

	specs: factor out specification checking to a separate makefile.
	* src/specl.mk (Specs): Move this section from here...
	* specs/specs.mk: New file.  ...to here.
	* Makefile.am: Include specs/specs.mk.

	specs: a minimal environment sharing spec.
	* specs/environment_spec.yaml: New file. Ensure before, after,
	examples in the same scope share execution environments
	correctly.
	* src/specl.mk (specl_SPECS): New macro. List all spec files.
	(EXTRA_DIST): Adjust.
	(check-local): Add dependencies. Remove unnecessary environment
	setting. Pass a static list of spec files.

	specl: read yaml format spec files.
	* yaml/lua52compat.h, yaml/yaml.c: New files.  Sources for yaml
	module.
	* yaml/yaml.mk: New file. Build yaml module.
	* Makefile.am: Include it.
	(lib_LTLIBRARIES): Initialise.
	* configure.ac (AC_INIT): Bump version to 2.
	(AM_INIT_AUTOMAKE): Use subdir-objects.
	(LT_PREREQ, LT_INIT): Add libtool setup.
	(AC_PROG_CC, AC_HEADER_STDC): Add C compiler setup.
	(AC_CONFIG_HEADERS): Make config.h.
	* specs/specl_spec.lua: Move from here...
	* specs/specl_spec.yaml: ...to here. Reformat to yaml.
	* src/specl.mk (check-local): Move from here...
	* specs/specs.mk: New file. ...to here.
	* src/specl.lua (run_examples): YAML doesn't provide a pleasant
	way to format reserved descriptions (before, after) outside of
	the ordered list of actual examples, so we have to make a first
	pass over the list to extract them, and then be careful not to
	run them again in the main loop.

	specl: fix --version and --help formatting with stdlib-33 getopt.
	* src/specl.in (prog.version): Separate out copyright notice...
	(prog.copyright): ...to here.
	(prog.description): Latest stdlib getopt doesn't need double
	newline paragraph separators.
	* src/version.lua.in (M.COPYRIGHT_NOTICE): Rejustify slightly.
	Point to gnu licenses webpage rather than COPYING file, which
	might have been lost during installation!

	rockspecs: add dependency on latest stdlib rock.
	* specl-rockspec.lua (dependencies): Add stdlib.

	maint: don't check release tarball file in on release branch.
	* .gitignore: Ignore specl-*.tar.gz.
	* build-aux/.gitignore: Don't ignore manually imported
	gitlog-to-changelog.

	specl: update to cleaner stdlib-33 getopt formats.
	* src/version.lua.in (M.COPYRIGHT_NOTICE): Remove stray '\n'.
	* src/specl.in (prog): No longer needs to be a magic global.
	(options): Ditto.  Move from here...
	(prog.options): ...to here.
	(prog.purpose, prog.description): Reword to match rockspec.
	(prog.version): Add this for --version output.
	(prog.banner): Remove.

	maint: fix typos in GNUmakefile.
	* GNUmakefile (unpack-distcheck-release): Add missing \s, ` and '.
	(Makefile.in): Only one '-' in '-Wall'.

	configury: install correctly from './configure; make all install'.
	The latest 'm4/ax_lua.m4' sets up pkgluadir to point into Lua's
	module directory.
	* Makefile.am (install_edit, inplace_edit): Remove useless
	@pkgdatadir@ and @pkgdocdir@ substitutions.
	* src/specl.mk (specldatadir): Remove.
	(specl_install_edit, specl_inplace_edit): Use pkgluadir instead.
	(dist_specldata_DATA): Rename from this...
	(dist_pkglua_DATA): ...to this.
	* src/specl.in (package.path): Inject pkgluadir substitution.
	(PATH_DATA, PATH_DOCDIR): Remove.  Unused variables.

	configury: add rockspec machinery.
	* specl-rockspec.lua: New file. Rockspec data.
	* build-aux/mkrockspecs.lua: New file. Reuben's templating
	rockspec building script.
	* GNUmakefile (luarocks-config.lua, rockspecs): Use it to build
	rockspecs.
	* src/specl.mk (EXTRA_DIST): Add build-aux/mkrockspecs.lua.

2013-02-24  Gary V. Vaughan  <gary@gnu.org>

	specs: specl specs for specl.
	* src/specl.mk (check-local): Run specs with 'make check'.

	configury: use ./bootstrap && ./configure && make & sudo make install.
	* bootstrap: New file, from Libtool master HEAD.
	* bootstrap.conf: New file.  Configure bootstrap for Specl.
	* build-aux/gitlog-to-changelog: New file.  Required for
	'make dist'.
	* configure.ac: New file. Check Specl build prerequisites.
	* m4/ax_compare_version.m4, m4/ax_lua.m4, m4/ax_with_prog.m4:
	New files. Used by configure.ac.
	* src/version.lua.in: New file.  Configured constants.
	* specl: Moved from here...
	* specl.in: ...to here.  Rework to use src/version.lua.in.
	* Makefile.am: New file. Top-level non-recursive Makefile.
	* src/specl.mk: New file. Make fragment for specl directory.
	* .gitignore, build-aux/.gitignore, src/.gitignore: New files.

2013-02-22  Gary V. Vaughan  <gary@gnu.org>

	specl: set _G._SPEC to allow modules to expose additional APIs.
	When a non-public API is being specified, we need a way to inform
	the module to give the specification access to it.
	* specl (_G._SPEC): Set this to true.
	* src/specl.lua (M): Put _expect into the module table if it is set.
	(matchers.contain): Improve wording of error message.
	* specs/specl_spec.lua (describe contain matcher): Add spec for
	error message.
	* src/specl.lua (matchers.match): Improve wording of error message.
	* specs/specl_spec.lua (describe match matcher): Add spec for error
	message.

	maint: store the version number in the interface table.
	* src/specl.lua (M): Add _VERSION key.
	* specl (prog): Use it in the --version output.

	matchers: compare table key/value contents using contain matcher.
	* src/specl.lua: When checking expectations against a table,
	compare against each key and value in the table.
	* specs/specl_spec.lua: Remove fake specs.
	Specify behaviour of contain matcher.
	* specl: Remove obsolete TODO entries.
	* README.md: Document it.

	formatters: Be consistent when reporting met expectations.
	* src/specl.lua (report): Add "Met" prefix to output.
	(progress): Write "expectations met", not "examples worked".

	matchers: make the contain and match matchers useable.
	Fix some silly bugs preventing these matchers from working
	properly.
	* src/specl.lua (matchers.match): Use VALUE consistently for
	parameter name.
	Set the return condition properly.
	(matchers.contain): Likewise.
	string.match patterns are not anchored, so no need to bookend
	with .*.

2013-02-21  Gary V. Vaughan  <gary@gnu.org>

	docs: initial draft documentation in README.
	* README.md: Rewritten with initial draft documentation.

2013-02-20  Gary V. Vaughan  <gary@gnu.org>

	matchers: make the error matcher useable.
	* src/specl.lua (matchers.error): Take arguments in reverse, so
	that 'should_error' is called like pcall, and 'expect' is a
	substring to match against any resulting error message.
	(report.expectation): Since error messages can be very long,
	reindent multiple lines as best as possible.

	matchers: work properly with _not_ expectations.
	* src/specl.lua (q): New function to quote strings in failure
	messages nicely.
	(matchers): Always return the failure status message, even if
	the matcher succeeded, since it may be inverted later with a 'not'.

	formatters: nicer fail message for report formatter.
	* src/specl.lua (report.expectations): Reformat slightly for
	better english, and to stand out better.

	formatter: group and format expectations every example.
	Fix a bug that counts a FAILed expectation incorrectly. Restart
	the counter for every example, not just at the start of the
	entire group.
	* src/specl.lua (run_examples): Don't save up all the expectations
	from the entire group before displaying, format them after every
	example completes.

	environments: fix the environment sharing TODO.
	* src/specl.lua (run_examples): Pass the correct block environment
	into the block, so that befores share settings with examples and
	afters correctly, and then reset when they go out of scope.
	* specl: Remove TODO.

	specl: implement an alternate format, selected by -v option.
	* specl (options): Accept -v or -verbose.
	* src/specl.lua (run): Add new format parameter.  Assuming what
	is passed conforms to the API, that formatter will be called as
	the examples are executed.
	(formatter): Move from here...
	(report): ...to here.
	(progress): New formatter that just prints dots as examples pass,
	or F as they fail.
	(formatter): Default formatter is the new progress formatter.
	(M): Put the two formatters in the public interface.
	* specl: Request the old report formatter in verbose mode.

	maint: refill copyright notices.

	specl: write a command line interface.
	* src/specl.lua: Don't clobber the global namespace with anything.
	(M): Record and return APIs.
	(Fake specs): Move from here...
	* specs/specl_spec.lua: New file. ...to here.
	* specl: New file. Load the specl module, and use it to process
	each spec file passed on the command line.
	* README.md: Update.

	maint: fix mistakes in pasted copyright header.
	* src/specl.lua: Actually, not part of GNU Zile, and didn't exist
	at all for the first 4 years of the 2009-2013 copyright range.

	maint: add README.
	* README.md: New file. Barely useful at the moment...

	specl: initial import.
